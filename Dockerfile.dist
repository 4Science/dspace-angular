# syntax=docker/dockerfile:1.7-labs

# This image will be published as dspace/dspace-angular:$DSPACE_VERSION-dist
# See https://github.com/DSpace/dspace-angular/tree/main/docker for usage details

# Test build:
# docker build -f Dockerfile.dist -t dspace/dspace-angular:dspace-8_x-dist .

# Angular 17 + Node 22 optimized Dockerfile
ARG NODE_VERSION=22
ARG DSPACE_VERSION=dspace-cris-2024_02_x
ARG DOCKER_REGISTRY=docker.io

FROM ${DOCKER_REGISTRY:-docker.io}/4science/dspace-cris-dependencies:${DSPACE_VERSION:-dspace-cris-2024_02_x} AS build

COPY --parents src/** config/** webpack/** docker/dspace-ui.json angular.json server.ts startup-message.ts tsconfig.json tsconfig.app.json tsconfig.server.json tsconfig.spec.json tsconfig.ts-node.json typedoc.json /app/

RUN npm install --global yarn

WORKDIR /app

# Build Angular app
RUN yarn build:prod

# ---- Production image ----
FROM docker.io/node:${NODE_VERSION-22}-alpine AS prod

# Install pm2 globally and clean npm cache
RUN npm install --global pm2 && npm cache clean --force

WORKDIR /app

# Only copy built files and config
COPY --chown=node:node --from=build /app/dist /app/dist
COPY --chown=node:node --from=build /app/config /app/config
COPY --chown=node:node --from=build /app/docker/dspace-ui.json /app/dspace-ui.json

USER node
ENV NODE_ENV=production
EXPOSE 4000

CMD ["pm2-runtime", "start", "dspace-ui.json", "--json"]
